<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Fun√ß√µes com Resolu√ß√£o Formal</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* [ESTILOS GERAIS MANTIDOS] */
        body { font-family: 'Arial', sans-serif; display: flex; margin: 0; padding: 0; background-color: #e9ebee; min-height: 100vh; }
        .left-panel { width: 400px; background-color: #f8f8f8; border-right: 1px solid #ccc; padding: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; align-items: center; gap: 20px; } 
        
        .analysis-panel {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 350px;
        }

        h2 { color: #4b5cff; margin-top: 0; margin-bottom: 20px; font-size: 20px; text-align: center; }
        .analysis-results p { margin: 5px 0; font-size: 15px; color: #333; }
        .analysis-results strong { color: #4b5cff; }

        .evaluation-group { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .evaluation-group button { width: 30%; padding: 8px; background-color: #673ab7; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .evaluation-group button:hover { background-color: #512da8; }

        #y-value { margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background-color: #f9f9f9; text-align: center; }

        /* Estilos do Passo a Passo (Resolu√ß√£o Formal) */
        #step-by-step-output {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
        .resolution-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .resolution-section:last-child { border-bottom: none; padding-bottom: 0; }
        .resolution-section h4 { font-size: 16px; color: #4b5cff; margin: 0 0 5px 0; border-left: 3px solid #673ab7; padding-left: 8px; }
        .formula-line { font-family: monospace; background-color: #e8eaf6; padding: 4px 6px; border-radius: 4px; display: block; margin: 5px 0; overflow-x: auto; white-space: nowrap; }
        .final-answer { font-size: 16px; font-weight: bold; color: #2e7d32; padding: 5px 0; border-top: 1px solid #ccc; margin-top: 10px; text-align: center; }
        
        /* Estilos para An√°lise Polinomial */
        .poly-result { margin: 5px 0; padding: 5px; border-bottom: 1px dotted #ccc; }
        .poly-result strong { font-weight: bold; color: #e91e63; } 
        .poly-coefs { font-family: monospace; font-size: 14px; background-color: #fbebf7; padding: 3px 6px; border-radius: 4px; display: inline-block; }

        /* [ESTILOS DO PAINEL DIREITO MANTIDOS] */
        .right-panel { flex-grow: 1; background-color: #ffffff; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .graph-controls { padding: 15px; border-bottom: 1px solid #ccc; background-color: #fafafa; }
        .graph-input { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .graph-input input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; position: relative; z-index: 10;}
        #js-code-display { background-color: #e0f7fa; color: #004d40; padding: 5px 10px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: nowrap; overflow-x: auto; }
        .plot-btn, .clear-btn { padding: 8px 15px; background-color: #4b5cff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .clear-btn { background-color: #f44336; }
        /* NOVO: Estilo para o bot√£o de Ajuda */
        .help-btn { 
            padding: 8px 10px; 
            background-color: #ff9800; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
            font-size: 14px;
        }
        .help-btn:hover {
            background-color: #e68900;
        }

        #chartjs-container { flex-grow: 1; width: 100%; padding: 20px; box-sizing: border-box; display: flex; justify-content: center; align-items: center; }
        .graph-keypad { padding: 15px; background-color: #e9ebee; border-top: 1px solid #ccc; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .keypad-op { background-color: #e0f7fa; color: #007bff; }
    </style>
</head>
<body>

    <div class="left-panel">
        
        <div id="polynomial-analysis" class="analysis-panel">
            <h2>An√°lise Polinomial ($ax^2 + bx + c$)</h2>
            
            <div id="poly-results">
                <p>Nenhuma fun√ß√£o quadr√°tica plotada. Tente: <span class="poly-coefs">x¬≤ - x - 2</span></p>
            </div>
        </div>
        
        <div class="analysis-panel">
            <h2>An√°lise Global do Gr√°fico üìâ</h2>
            
            <div class="analysis-results">
                <p>Dom√≠nio (X Plotado): <strong id="domain-value">[-6.5, 6.5]</strong></p>
                <p>M√≠nimo (Y): <strong id="min-value">Aguardando Gr√°fico...</strong></p>
                <p>M√°ximo (Y): <strong id="max-value">Aguardando Gr√°fico...</strong></p>
                <p>Imagem (Y Global): <strong id="range-value">Aguardando Gr√°fico...</strong></p>
            </div>

            <div class="evaluation-group">
                <label>Calcular **Resultado** $f(x)$:</label>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="x-input" style="margin-bottom: 0;">**Dom√≠nio (x)** =</label>
                    <input type="number" id="x-input" value="1.5708" step="any" style="flex-grow: 1;">
                    <button onclick="evaluateAtX()">Calcular</button>
                </div>
                <div id="y-value">
                    <p>f(<strong id="x-result-label">1.5708</strong>) $\approx$ **Resultado** (y): <strong id="y-result">...</strong></p>
                </div>
            </div>

            <div id="step-by-step-output">
                **Resolu√ß√£o de f(x):**
                <p>Digite um valor para 'x' e clique em "Calcular".</p>
            </div>

        </div>

    </div>

    <div class="right-panel">
        <div class="graph-controls">
            <div class="graph-input">
                <label for="chartjs-input">y =</label>
                <div style="flex-grow: 1; position: relative;">
                    <input type="text" id="chartjs-input" placeholder="Ex: x¬≤ - x - 2" value="x¬≤ - x - 2">
                    <div id="suggestion-box"></div>
                </div>
                
                <button class="plot-btn" onclick="plotChartJsFunction()">Plotar</button>
                <button class="help-btn" onclick="showParameterAnalysis()">Ajuda da F√≥rmula</button> 
                <button class="clear-btn" onclick="clearChartJs()">Limpar</button>
            </div>
            
            <label style="font-size: 12px; color: #555;">F√≥rmula JS para Plotagem:</label>
            <div id="js-code-display">Aguardando fun√ß√£o...</div>
        </div>
        
        <div id="chartjs-container">
            <canvas id="myChart"></canvas>
        </div>

        <div class="graph-keypad">
            <button class="keypad-btn keypad-func" data-value="sin(">sin(</button>
            <button class="keypad-btn keypad-func" data-value="cos(">cos(</button>
            <button class="keypad-btn keypad-func" data-value="tan(">tan(</button>
            <button class="keypad-btn keypad-const" data-value="pi">œÄ</button>
            <button class="keypad-btn keypad-const" data-value="x">x</button>
            <button class="keypad-btn keypad-op" data-value="(">(</button>
            
            <button class="keypad-btn" data-value="7">7</button>
            <button class="keypad-btn" data-value="8">8</button>
            <button class="keypad-btn" data-value="9">9</button>
            <button class="keypad-btn keypad-op" data-value="/">/</button>
            <button class="keypad-btn keypad-op" data-value="‚Ä¢">‚Ä¢</button> 
            <button class="keypad-btn keypad-op" data-value=")">)</button>

            <button class="keypad-btn" data-value="4">4</button>
            <button class="keypad-btn" data-value="5">5</button>
            <button class="keypad-btn" data-value="6">6</button>
            <button class="keypad-btn keypad-op" data-value="+">+</button>
            <button class="keypad-btn keypad-op" data-value="-">-</button>
            <button class="keypad-btn keypad-op" onclick="deleteChar()">‚å´</button>

            <button class="keypad-btn" data-value="1">1</button>
            <button class="keypad-btn" data-value="2">2</button>
            <button class="keypad-btn" data-value="3">3</button>
            <button class="keypad-btn keypad-op" data-value="^">^</button> 
            <button class="keypad-btn keypad-op" data-value=".">.</button>
            <button class="keypad-btn keypad-op" data-value="0">0</button>
        </div>
    </div>

<script>
    let chartInstance; 
    let currentFunctionString = ""; 
    let currentJSFunction = null; 
    let inSuperscriptMode = false;
    const superscriptMap = { '0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥', '5': '‚Åµ', '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ' };
    const reverseSuperscriptMap = { '‚Å∞': '0', '¬π': '1', '¬≤': '2', '¬≥': '3', '‚Å¥': '4', '‚Åµ': '5', '‚Å∂': '6', '‚Å∑': '7', '‚Å∏': '8', '‚Åπ': '9' };
    const superscriptKeys = Object.keys(superscriptMap);

    const CONSTANT_MAP = { 'pi': Math.PI, 'e': Math.E };

    const MATH_FUNCTIONS = {
        'sin(': 'Math.sin(', 'cos(': 'Math.cos(', 'tan(': 'Math.tan(',
        'asin(': 'Math.asin(', 'acos(': 'Math.acos(', 'atan(': 'Math.atan(',
        'sqrt(': 'Math.sqrt(', 'abs(': 'Math.abs(', 'log(': 'Math.log(', 
        'log10(': 'Math.log10(', 'exp(': 'Math.exp(', 'ceil(': 'Math.ceil(',
        'floor(': 'Math.floor(', 'round(': 'Math.round(',
        'pi': 'Math.PI', 'e': 'Math.E',
    };
    
    const SUGGESTIONS = Object.keys(MATH_FUNCTIONS)
        .filter(key => key.includes('(') || key.length > 1)
        .map(key => key.replace('(', '')); 


    // --- FUN√á√ïES DE PR√â-PROCESSAMENTO E PLOTAGEM (MANTIDAS) ---
    
    function sanitizeFunctionString(formulaString) {
        let processedString = formulaString;
        
        // 1. Converte o operador de multiplica√ß√£o visual
        processedString = processedString.replace(/‚Ä¢/g, '*');

        // 2. Converte caracteres de sobrescrito de volta para '^' e depois para Math.pow()
        let simplifiedString = '';
        let currentSuperscript = '';
        for (let i = 0; i < processedString.length; i++) {
            const char = processedString[i];
            if (reverseSuperscriptMap[char]) {
                currentSuperscript += reverseSuperscriptMap[char];
            } else {
                if (currentSuperscript) {
                    simplifiedString += '^' + currentSuperscript;
                    currentSuperscript = '';
                }
                simplifiedString += char;
            }
        }
        if (currentSuperscript) {
            simplifiedString += '^' + currentSuperscript;
        }
        processedString = simplifiedString;

        // B. Substitui a nota√ß√£o de pot√™ncia simples (Base^Exp) por Math.pow()
        processedString = processedString.replace(/([a-z0-9\.\)]+)\^([a-z0-9\.]+)/gi, 'Math.pow($1, $2)');
        processedString = processedString.replace(/x\^(\d)/gi, 'Math.pow(x, $1)'); 
        processedString = processedString.replace(/(\d)\^(\d)/gi, 'Math.pow($1, $2)');
        
        // 3. Substitui fun√ß√µes e constantes
        for (const mathKey in MATH_FUNCTIONS) {
            const escapedKey = mathKey.replace(/([()])/g, "\\$1");
            const regex = new RegExp(escapedKey, 'gi'); 
            processedString = processedString.replace(regex, MATH_FUNCTIONS[mathKey]);
        }
        
        // 4. Garante que multiplica√ß√µes impl√≠citas sejam expl√≠citas
        processedString = processedString.replace(/(\d+)([a-z(])/gi, '$1*$2');
        processedString = processedString.replace(/(Math\.PI|Math\.E|x)([a-z(])/g, '$1*$2');
        
        return processedString;
    }


    function generateFunctionData(formulaString, xMin = -6.5, xMax = 6.5, numPoints = 500) {
        const data = [];
        const step = (xMax - xMin) / numPoints;
        const jsFormula = sanitizeFunctionString(formulaString);
        document.getElementById('js-code-display').textContent = jsFormula;

        try {
            currentJSFunction = new Function('x', 'Math', `return ${jsFormula};`);
        } catch (e) {
            console.error("Erro de sintaxe ao criar fun√ß√£o JS:", e);
            document.getElementById('js-code-display').textContent = `ERRO: ${e.message}`;
            alert("Erro de sintaxe na fun√ß√£o. Verifique par√™nteses ou operadores.");
            return [];
        }

        let minY = Infinity;
        let maxY = -Infinity;
        let validPointFound = false;

        for (let x = xMin; x <= xMax; x += step) {
            let y;
            try {
                y = currentJSFunction(x, Math);
                
                if (Math.abs(y) > 100 || isNaN(y) || !isFinite(y)) {
                    y = NaN; 
                } else {
                    minY = Math.min(minY, y);
                    maxY = Math.max(maxY, y);
                    validPointFound = true;
                }

                data.push({ x: x, y: y });

            } catch (e) {
                data.push({ x: x, y: NaN });
            }
        }
        
        updateAnalysisPanel(xMin, xMax, validPointFound ? minY : null, validPointFound ? maxY : null);
        analyzePolynomial(formulaString); 
        
        return data;
    }

    // --- FUN√á√ÉO PARA AN√ÅLISE POLINOMIAL (SEGUNDO GRAU - MANTIDA) ---
    function analyzePolynomial(formulaString) {
        const outputDiv = document.getElementById('poly-results');
        let cleanStr = formulaString.toLowerCase();
        
        cleanStr = cleanStr.replace(/x¬≤/g, 'x^2').replace(/‚Ä¢/g, '*');
        
        let a = 0, b = 0, c = 0;
        
        const aMatch = cleanStr.match(/([+-]?\s*\d*\.?\d*)\s*x\^2/);
        if (aMatch) {
            let val = aMatch[1].replace(/\s/g, '');
            if (val === '+' || val === '') a = 1;
            else if (val === '-') a = -1;
            else a = parseFloat(val);
        }

        const bMatch = cleanStr.match(/([+-]?\s*\d*\.?\d*)\s*x(?![\^])/);
        if (bMatch) {
            let val = bMatch[1].replace(/\s/g, '');
            if (val === '+' || val === '') b = 1;
            else if (val === '-') b = -1;
            else b = parseFloat(val);
        }
        
        const cMatch = cleanStr.match(/([+-]?\s*\d+\.?\d*)$/);
        if (cMatch && !cleanStr.includes('^')) { 
             c = parseFloat(cMatch[1].replace(/\s/g, ''));
        }

        const isQuadratic = a !== 0 && !cleanStr.includes('sin(') && !cleanStr.includes('cos(') && !cleanStr.includes('log(') && !cleanStr.includes('pi') && !cleanStr.includes('sqrt(');
        
        if (!isQuadratic) {
            outputDiv.innerHTML = '<p>Esta fun√ß√£o n√£o √© um polin√¥mio de segundo grau simples.</p><p>Tente: <span class="poly-coefs">x¬≤ - x - 2</span></p>';
            return;
        }

        // --- C√ÅLCULO DE DELTA, RA√çZES E V√âRTICE ---
        const delta = b * b - 4 * a * c;
        const vx = -b / (2 * a);
        const vy = currentJSFunction(vx, Math);
        
        let rootsHTML = '';
        let deltaType = 'Duas ra√≠zes reais (x‚ÇÅ $\\neq$ x‚ÇÇ)';

        if (delta > 0) {
            const x1 = (-b + Math.sqrt(delta)) / (2 * a);
            const x2 = (-b - Math.sqrt(delta)) / (2 * a);
            rootsHTML = `<p class="poly-result">x‚ÇÅ $\\approx$ ${x1.toFixed(4)}</p><p class="poly-result">x‚ÇÇ $\\approx$ ${x2.toFixed(4)}</p>`;
        } else if (delta === 0) {
            const x1 = -b / (2 * a);
            rootsHTML = `<p class="poly-result">x‚ÇÅ = x‚ÇÇ $\\approx$ ${x1.toFixed(4)}</p>`;
            deltaType = 'Uma raiz real (x‚ÇÅ = x‚ÇÇ)';
        } else {
            rootsHTML = '<p class="poly-result">N√£o h√° ra√≠zes reais.</p>';
            deltaType = 'N√£o h√° ra√≠zes reais (Ra√≠zes complexas)';
        }
        
        outputDiv.innerHTML = `
            <h4>Coeficientes:</h4>
            <p class="poly-coefs">a = ${a.toFixed(2)} | b = ${b.toFixed(2)} | c = ${c.toFixed(2)}</p>
            
            <h4>Discriminante ($\Delta$):</h4>
            <p class="poly-result">$\Delta = b^2 - 4ac$</p>
            <p class="poly-result">$\Delta = $ <strong>${delta.toFixed(4)}</strong></p>
            <p class="poly-result">${deltaType}</p>

            <h4>Ra√≠zes (Z<span style="vertical-align: super; font-size: 0.7em;">eros</span>):</h4>
            ${rootsHTML}

            <h4>V√©rtice (M√°ximo/M√≠nimo):</h4>
            <p class="poly-result">x<span style="vertical-align: sub; font-size: 0.7em;">v</span> = <strong>${vx.toFixed(4)}</strong></p>
            <p class="poly-result">y<span style="vertical-align: sub; font-size: 0.7em;">v</span> = <strong>${vy.toFixed(4)}</strong></p>
            <p class="poly-result">Concavidade: ${a > 0 ? 'Para Cima (M√≠nimo)' : 'Para Baixo (M√°ximo)'}</p>
        `;
    }

    // --- NOVA FUN√á√ÉO: EXPLICA√á√ÉO DE PAR√ÇMETROS ---
    function showParameterAnalysis() {
        const formula = document.getElementById('chartjs-input').value.toLowerCase();
        let explanation = "N√£o foi poss√≠vel identificar o tipo de fun√ß√£o (Quadr√°tica ou Trigonom√©trica) para fornecer uma an√°lise detalhada dos par√¢metros.";
        
        const TRIG_REGEX = /sin\(|cos\(|tan\(/;

        if (TRIG_REGEX.test(formula)) {
            // Explica√ß√£o para Fun√ß√µes Trigonom√©tricas (ex: y = A + B * sin(C * x + D))
            explanation = "Fun√ß√£o Trigonom√©trica (exemplo: y = A + B * sin(C * x + D)):\n\n" +
                          "1. Coeficiente A (Deslocamento Vertical):\n" +
                          "   - Desloca a onda para cima (A > 0) ou para baixo (A < 0).\n" +
                          "   - Define o Eixo de Simetria da onda (Linha M√©dia).\n" +
                          "\n" +
                          "2. Coeficiente B (Amplitude):\n" +
                          "   - Define a altura da onda (amplitude vertical).\n" +
                          "   - Aumenta a amplitude (B > 1) ou comprime (B < 1).\n" +
                          "   - A Imagem da fun√ß√£o ser√° [A - |B|, A + |B|].\n" +
                          "\n" +
                          "3. Coeficiente C (Per√≠odo):\n" +
                          "   - Define a frequ√™ncia da onda (compress√£o horizontal).\n" +
                          "   - O Per√≠odo (P) √© calculado por P = 2œÄ / |C|.\n" +
                          "   - Se C > 1, o per√≠odo diminui (mais ondas). Se C < 1, o per√≠odo aumenta (menos ondas).\n" +
                          "\n" +
                          "4. Coeficiente D (Defasagem/Fase):\n" +
                          "   - Desloca a onda horizontalmente (transla√ß√£o horizontal).\n" +
                          "   - Afeta o ponto de in√≠cio do ciclo.";

        } else if (formula.includes('x^2') || formula.includes('x¬≤')) {
            // Explica√ß√£o para Fun√ß√µes Quadr√°ticas (ex: y = a * x^2 + b * x + c)
            explanation = "Fun√ß√£o Quadr√°tica (Par√°bola: y = a * x¬≤ + b * x + c):\n\n" +
                          "1. Coeficiente a (Concavidade):\n" +
                          "   - Se a > 0: Concavidade para cima (a fun√ß√£o tem um Ponto de M√≠nimo).\n" +
                          "   - Se a < 0: Concavidade para baixo (a fun√ß√£o tem um Ponto de M√°ximo).\n" +
                          "   - Afeta a abertura da par√°bola (aumenta o valor, fecha a par√°bola).\n" +
                          "\n" +
                          "2. Coeficiente b (Inclina√ß√£o/Simetria):\n" +
                          "   - Define a inclina√ß√£o da par√°bola.\n" +
                          "   - Afeta a posi√ß√£o horizontal do V√©rtice (Eixo de Simetria x = -b / 2a).\n" +
                          "\n" +
                          "3. Coeficiente c (Transla√ß√£o Vertical/Intercepto):\n" +
                          "   - Desloca a par√°bola verticalmente.\n" +
                          "   - √â o valor onde a par√°bola cruza o eixo y (o ponto (0, c)).";
        }
        
        alert("An√°lise dos Par√¢metros da Fun√ß√£o:\n\n" + explanation);
    }

    // --- FUN√á√ïES GERAIS DE CONTROLE (MANTIDAS) ---

    function updateAnalysisPanel(xMin, xMax, minY, maxY) {
        // [L√≥gica de atualiza√ß√£o do painel de An√°lise MANTIDA, com r√≥tulos ajustados no HTML]
        const domainElement = document.getElementById('domain-value');
        const minElement = document.getElementById('min-value');
        const maxElement = document.getElementById('max-value');
        const rangeElement = document.getElementById('range-value');

        domainElement.textContent = `[${xMin.toFixed(2)}, ${xMax.toFixed(2)}]`;

        if (minY !== null && maxY !== null) {
            minElement.textContent = minY.toFixed(4);
            maxElement.textContent = maxY.toFixed(4);
            rangeElement.textContent = `[${minY.toFixed(4)}, ${maxY.toFixed(4)}]`;
        } else {
            minElement.textContent = 'N√£o encontrado no intervalo';
            maxElement.textContent = 'N√£o encontrado no intervalo';
            rangeElement.textContent = 'N√£o encontrado no intervalo';
        }
        
        document.getElementById('y-result').textContent = '...';
    }


    function plotChartJsFunction() {
        const inputElement = document.getElementById('chartjs-input');
        currentFunctionString = inputElement.value.trim();

        if (!currentFunctionString) {
            clearChartJs();
            return;
        }

        const dataPoints = generateFunctionData(currentFunctionString);
        const ctx = document.getElementById('myChart').getContext('2d');
        
        if (chartInstance) {
            chartInstance.destroy();
        }

        if (dataPoints.length === 0 && currentFunctionString.length > 0) {
            currentJSFunction = null;
            updateAnalysisPanel(-6.5, 6.5, null, null);
            analyzePolynomial(currentFunctionString);
            return;
        }

        chartInstance = new Chart(ctx, {
            type: 'scatter', 
            data: {
                datasets: [{
                    label: 'y = ' + currentFunctionString,
                    data: dataPoints,
                    borderColor: '#4b5cff',
                    borderWidth: 2,
                    fill: false,
                    showLine: true, 
                    pointRadius: 0, 
                    tension: 0 
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Gr√°fico de Fun√ß√£o: y = ' + currentFunctionString, font: { size: 18 } },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        type: 'linear', position: 'bottom', title: { display: true, text: 'x (radianos)' }, min: -6.5, max: 6.5, grid: { color: '#eee' },
                        ticks: {
                            callback: function(val, index) {
                                const pi = Math.PI;
                                if (Math.abs(val - (-2*pi)) < 0.1) return '-2œÄ';
                                if (Math.abs(val - (-pi)) < 0.1) return '-œÄ';
                                if (Math.abs(val - 0) < 0.1) return '0';
                                if (Math.abs(val - pi) < 0.1) return 'œÄ';
                                if (Math.abs(val - (2*pi)) < 0.1) return '2œÄ';
                                return '';
                            }
                        }
                    },
                    y: {
                        title: { display: true, text: 'y' }, grid: { color: '#eee' }, suggestedMin: -3, suggestedMax: 3
                    }
                }
            }
        });
    }

    function clearChartJs() {
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }
        document.getElementById('chartjs-input').value = "";
        document.getElementById('js-code-display').textContent = 'Aguardando fun√ß√£o...';
        document.getElementById('step-by-step-output').innerHTML = 'Passo a Passo de C√°lculo:<p>Nenhuma fun√ß√£o plotada.</p>';
        document.getElementById('poly-results').innerHTML = '<p>Nenhuma fun√ß√£o quadr√°tica plotada. Tente: <span class="poly-coefs">x¬≤ - x - 2</span></p>';
        currentJSFunction = null;
        updateAnalysisPanel(-6.5, 6.5, null, null); 
    }

    function evaluateAtX() {
        const xInput = document.getElementById('x-input');
        const xValue = parseFloat(xInput.value);
        const yResultElement = document.getElementById('y-result');
        const xLabelElement = document.getElementById('x-result-label');
        const stepOutputElement = document.getElementById('step-by-step-output');
        
        xLabelElement.textContent = xValue.toFixed(4);
        
        if (!currentJSFunction || !currentFunctionString) {
            yResultElement.textContent = 'N/A';
            stepOutputElement.innerHTML = '<h4>Fun√ß√£o N√£o Plotada</h4><p>Nenhuma fun√ß√£o est√° dispon√≠vel para c√°lculo.</p>';
            return;
        }

        if (isNaN(xValue)) {
            yResultElement.textContent = 'x inv√°lido.';
            stepOutputElement.innerHTML = '<h4>Entrada Inv√°lida</h4><p>O valor de x fornecido √© inv√°lido.</p>';
            return;
        }

        // --- GERA√á√ÉO DO PASSO A PASSO (RESOLU√á√ÉO FORMAL) ---
        let stepsHTML = '';
        let finalY;

        // 1. Apresenta√ß√£o da Fun√ß√£o
        stepsHTML += '<div class="resolution-section">';
        stepsHTML += '<h4>1. Fun√ß√£o Definida</h4>';
        stepsHTML += `<p>A fun√ß√£o a ser avaliada √©:</p>`;
        stepsHTML += `<span class="formula-line">f(x) = ${currentFunctionString}</span>`;
        stepsHTML += '</div>';

        // 2. Substitui√ß√£o
        stepsHTML += '<div class="resolution-section">';
        stepsHTML += '<h4>2. Substitui√ß√£o de Vari√°veis</h4>';
        
        let substitutionFormulaVisual = currentFunctionString.replace(/x/g, `(${xValue.toFixed(6)})`);
        
        for (const [key, value] of Object.entries(CONSTANT_MAP)) {
            const regex = new RegExp(key, 'g'); 
            substitutionFormulaVisual = substitutionFormulaVisual.replace(regex, `(${value.toFixed(6)})`);
        }

        stepsHTML += `<p>Substituindo <b>x (Dom√≠nio) = ${xValue.toFixed(6)}</b>, obtemos:</p>`;
        stepsHTML += `<span class="formula-line">f(${xValue.toFixed(6)}) = ${substitutionFormulaVisual}</span>`;
        stepsHTML += '</div>';
        
        // 3. Executa o C√°lculo e Resultado Final
        stepsHTML += '<div class="resolution-section">';
        stepsHTML += '<h4>3. C√°lculo e Resultado Final (Imagem)</h4>'; 

        try {
            finalY = currentJSFunction(xValue, Math);
            
            if (isNaN(finalY) || !isFinite(finalY)) {
                yResultElement.textContent = 'Indefinido';
                stepsHTML += `<p>O c√°lculo resultou em um valor <span class="final-answer" style="color: #d32f2f;">Indefinido</span> (Ex: divis√£o por zero ou dom√≠nio inv√°lido).</p>`;
            } else {
                yResultElement.textContent = finalY.toFixed(6);
                stepsHTML += `<p>O valor calculado de <b>y (Imagem)</b> para o <b>x</b> fornecido √©:</p>`;
                stepsHTML += `<div class="final-answer">f(${xValue.toFixed(4)}) $\\approx$ ${finalY.toFixed(6)}</div>`;
            }
        } catch (e) {
            yResultElement.textContent = 'Erro';
            stepsHTML += `<p>Houve um erro de execu√ß√£o no c√°lculo. Verifique a sintaxe da fun√ß√£o.</p>`;
            console.error("Erro ao avaliar y:", e);
        }
        
        stepsHTML += '</div>';
        stepOutputElement.innerHTML = stepsHTML;
    }


    // --- FUN√á√ïES DO TECLADO E SUGEST√ÉO (MANTIDAS) ---
    const inputField = document.getElementById('chartjs-input');
    const keypadButtons = document.querySelectorAll('.graph-keypad .keypad-btn');
    const suggestionBox = document.getElementById('suggestion-box');
    let activeSuggestionIndex = -1;

    keypadButtons.forEach(button => {
        button.addEventListener('click', () => {
            const value = button.getAttribute('data-value');
            if (value === '^') {
                inSuperscriptMode = true; 
            }
            if (value) {
                inputField.value += value;
                inputField.focus(); 
            }
            hideSuggestions();
        });
    });

    function deleteChar() {
        const lastChar = inputField.value.slice(-1);
        if (reverseSuperscriptMap[lastChar] || lastChar === '^') {
            inSuperscriptMode = false;
        }
        inputField.value = inputField.value.slice(0, -1);
        inputField.focus();
        showSuggestions();
    }
    
    inputField.addEventListener('input', () => {
        showSuggestions();

        if (inSuperscriptMode) {
            let value = inputField.value;
            const lastChar = value.slice(-1);
            const secondLastChar = value.slice(-2, -1);
            
            if (secondLastChar === '^' && superscriptMap[lastChar]) {
                const superscriptChar = superscriptMap[lastChar];
                value = value.slice(0, -2);
                inputField.value = value + superscriptChar;
                inSuperscriptMode = true;
                
            } else if (inputField.value.slice(-1) !== '^' && !superscriptMap[lastChar]) {
                inSuperscriptMode = false;
            }
        }
        
        if (inputField.value.slice(-1) === '^') {
            inSuperscriptMode = true;
        }
    });

    inputField.addEventListener('keydown', (e) => {
        const items = suggestionBox.querySelectorAll('.suggestion-item');
        
        if (e.key === 'ArrowDown' && (inSuperscriptMode || suggestionBox.style.display === 'block')) {
            e.preventDefault();
            if (inSuperscriptMode) {
                inSuperscriptMode = false;
                return;
            }
            if (items.length > 0) {
                activeSuggestionIndex = (activeSuggestionIndex + 1) % items.length;
                updateActiveSuggestion();
            }
            return;
        }
        
        if (suggestionBox.style.display === 'block' && items.length > 0) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeSuggestionIndex = (activeSuggestionIndex - 1 + items.length) % items.length;
                updateActiveSuggestion();
            } else if (e.key === 'Enter') {
                if (activeSuggestionIndex >= 0) {
                    e.preventDefault();
                    const selectedText = items[activeSuggestionIndex].textContent.replace('(...)', '').replace('(', '');
                    selectSuggestion(selectedText);
                } else {
                    plotChartJsFunction();
                    hideSuggestions();
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        } else if (e.key === 'Enter') {
            plotChartJsFunction();
        }
    });
    
    function showSuggestions() {
        const text = inputField.value.toLowerCase();
        const lastWordMatch = text.match(/([a-z]+)$/i); 
        const currentInput = lastWordMatch ? lastWordMatch[1] : '';
        
        suggestionBox.innerHTML = '';
        activeSuggestionIndex = -1;

        if (currentInput.length === 0) {
            hideSuggestions();
            return;
        }

        const filteredSuggestions = SUGGESTIONS.filter(suggestion => 
            suggestion.startsWith(currentInput)
        );

        if (filteredSuggestions.length === 0) {
            hideSuggestions();
            return;
        }

        filteredSuggestions.forEach((suggestion, index) => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion + (suggestion.length > 2 && !suggestion.includes('pi') && !suggestion.includes('e') ? '(...)' : ''); 
            div.onclick = () => selectSuggestion(suggestion);
            div.onmouseover = () => { activeSuggestionIndex = index; updateActiveSuggestion(); };
            suggestionBox.appendChild(div);
        });

        suggestionBox.style.display = 'block';
    }

    function hideSuggestions() {
        suggestionBox.style.display = 'none';
        suggestionBox.innerHTML = '';
    }

    function selectSuggestion(suggestion) {
        const text = inputField.value;
        const newText = text.replace(/([a-z]+)$/i, suggestion + (suggestion.includes('pi') || suggestion.includes('e') ? '' : '('));
        inputField.value = newText;
        inputField.focus();
        hideSuggestions();
    }

    function updateActiveSuggestion() {
        const items = suggestionBox.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            item.classList.toggle('active', index === activeSuggestionIndex);
        });
    }

    document.addEventListener('click', (e) => {
        if (e.target !== inputField && !suggestionBox.contains(e.target) && e.target.className !== 'keypad-btn' && e.target.className !== 'help-btn') {
            hideSuggestions();
            inSuperscriptMode = false;
        }
    });

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        plotChartJsFunction(); 
    });
</script>

</body>
</html>
