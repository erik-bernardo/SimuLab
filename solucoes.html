<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Química: Soluções e Misturas (V5)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ----------------------------------- */
        /* VARIÁVEIS E ESTILOS GERAIS */
        /* ----------------------------------- */
        :root {
            --sidebar-width: 300px;
            --cor-destaque: #007bff; /* Azul para Soluções */
            --cor-primaria: #007bff;
            --cor-fundo: #f0f0f0;
            --cor-simulacao: #ffffff;
            --cor-borda: #ccc;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--cor-fundo);
            margin: 0;
            padding: 0;
            color: #333;
            overflow: hidden;
            height: 100vh;
            display: flex;
        }

        /* ----------------------------------- */
        /* LAYOUT PRINCIPAL */
        /* ----------------------------------- */
        .simulation-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        
        /* PAINEL LATERAL (ESQUERDO) */
        .left-panel {
            width: var(--sidebar-width);
            background-color: #fff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            color: var(--cor-destaque);
            border-bottom: 2px solid var(--cor-borda);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        /* ÁTOMOS/SUBSTÂNCIAS ARRASTÁVEIS */
        .draggable-item {
            padding: 10px;
            margin: 8px 0;
            background-color: #f9f9f9;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            cursor: grab;
            transition: background-color 0.2s;
        }
        
        .draggable-item:hover {
            background-color: #e9e9e9;
        }
        
        .item-simbolo {
            font-weight: bold;
            color: var(--cor-destaque);
            margin-right: 10px;
        }
        
        /* ÁREA DE SIMULAÇÃO (DIREITA) */
        .simulation-area {
            flex-grow: 1;
            background-color: var(--cor-simulacao);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* COPO/BEAKER */
        #beaker-container {
            position: relative;
            width: 300px;
            height: 400px;
            border: 5px solid #333;
            border-top: none;
            border-radius: 0 0 30px 30px;
            background-color: #fff;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* ONDE A SOLUÇÃO FICA */
        #beaker-solution {
            position: absolute;
            bottom: 0;
            width: 100%;
            /* Altura inicial baixa, será ajustada via JS */
            height: 50px; 
            background: rgba(100, 149, 237, 0.5); /* Cornflower Blue translúcido */
            transition: height 0.5s ease-in-out, background 0.5s;
        }

        /* RESULTADO/INFORMAÇÕES */
        #results-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 250px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--cor-borda);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .results-info {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .results-info strong {
            color: #000;
        }

        /* Estilo para Soluto Indissolúvel (Sólido no Fundo) */
        #beaker-sediment {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0; /* Começa com zero */
            background-color: #8B4513; /* Marrom para sedimento */
            transition: height 0.5s;
        }
        /* NOVOS ESTILOS PARA VISUALIZAÇÃO */

/* Camada de Óleo (Ácido Oleico) */
#beaker-oil-layer {
    position: absolute;
    top: 0; /* Começa no topo da água/solução */
    width: 100%;
    height: 0;
    background-color: rgba(255, 255, 0, 0.7); /* Amarelo translúcido */
    transition: height 1s ease-out;
    border-radius: 0 0 30px 30px; /* Para manter o formato do copo */
    z-index: 2; /* Acima da solução */
}

/* Animação da substância caindo */
#falling-substance {
    position: absolute;
    top: -50px; /* Começa acima do copo */
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 20px;
    background-color: transparent;
    border-radius: 50%;
    z-index: 5;
    opacity: 0;
    pointer-events: none;
}

/* Estilo para simular o pó caindo */
@keyframes fall-in {
    0% { top: -50px; opacity: 1; transform: scale(1); }
    100% { top: 380px; opacity: 0; transform: scale(0.5); } /* Altura do copo é 400px */
}

    </style>
</head>
<body>

<div class="left-panel">
    <h2 class="section-title"><i class="fas fa-flask"></i> Substâncias (Arrastar para o Copo)</h2>
    
    <div id="water" class="draggable-item" draggable="true" data-type="solvent" data-symbol="H2O" data-name="Água" data-solubility="MAX" data-initial-volume="250" data-solubility-limit="N/A">
        <span class="item-simbolo">H₂O</span> Água (Solvente Padrão, 250 mL)
    </div>

    <div id="salt" class="draggable-item" draggable="true" data-type="solute" data-symbol="NaCl" data-name="Cloreto de Sódio" data-mass="15" data-color="none" data-solubility-limit="35.9">
        <span class="item-simbolo">NaCl</span> Sal Comum (15g)
    </div>
    
    <div id="kmno4" class="draggable-item" draggable="true" data-type="solute" data-symbol="KMnO4" data-name="Permanganato de Potássio" data-mass="3" data-color="purple" data-solubility-limit="6.4">
        <span class="item-simbolo">KMnO₄</span> Permanganato de Potássio (3g)
    </div>

    <div id="oleic-acid" class="draggable-item" draggable="true" data-type="solute" data-symbol="C18H34O2" data-name="Ácido Oleico" data-mass="10" data-color="yellow" data-solubility-limit="0">
        <span class="item-simbolo">C₁₈H₃₄O₂</span> Ácido Oleico (10g, Óleo)
    </div>
    
    <div id="sugar" class="draggable-item" draggable="true" data-type="solute" data-symbol="C12H22O11" data-name="Sacarose" data-mass="30" data-color="none" data-solubility-limit="203.9">
        <span class="item-simbolo">C₁₂H₂₂O₁₁</span> Açúcar (30g)
    </div>
    
    <div id="sand" class="draggable-item" draggable="true" data-type="solute" data-symbol="SiO2" data-name="Dióxido de Silício" data-mass="5" data-color="gray" data-solubility-limit="0">
        <span class="item-simbolo">SiO₂</span> Areia (5g, Insolúvel)
    </div>

    <h2 class="section-title" style="margin-top: 20px;"><i class="fas fa-tools"></i> Controles</h2>
    <button id="reset-solution" style="padding: 10px; background-color: var(--cor-destaque); color: white; border: none; border-radius: 5px; cursor: pointer;">
        <i class="fas fa-undo"></i> Reiniciar Solução
    </button>
</div>

<div id="simulation-area" class="simulation-area">
    <h1>Simulador de Soluções</h1>
    <p>Arraste uma substância da esquerda para o copo.</p>

    <div id="beaker-container">
        <div id="beaker-oil-layer"></div> 
        <div id="beaker-solution"></div>
        <div id="beaker-sediment"></div>
        <div id="falling-substance"></div> 
        <div id="drop-target" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
    </div>

    </div>
   

    <div id="simulation-area" class="simulation-area">
        <h1>Simulador de Soluções</h1>
        <p>Arraste uma substância da esquerda para o copo.</p>

        <div id="beaker-container">
            <div id="beaker-solution"></div>
            <div id="beaker-sediment"></div>
            <div id="drop-target" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
        </div>

        <div id="results-panel">
            <h3 class="section-title" style="border-bottom: 1px solid var(--cor-borda); margin-bottom: 10px;">
                <i class="fas fa-chart-bar"></i> Análise
            </h3>
            <div class="results-info"><strong>Volume de Solvente:</strong> <span id="volume-info">0 mL</span></div>
            <div class="results-info"><strong>Massa de Soluto:</strong> <span id="mass-info">0 g</span></div>
            <div class="results-info"><strong>Concentração (g/mL):</strong> <span id="concentration-info">0.00 g/mL</span></div>
            <div class="results-info" style="font-weight: bold;"><strong>Classificação:</strong> <span id="classification-info">Vazio</span></div>
            <div class="results-info"><strong>Sedimento:</strong> <span id="sediment-info">0 g</span></div>
        </div>
    </div>


<script>
    // ==================================================================================================
    // 2. CONSTANTES E ESTADO GLOBAL
    // ==================================================================================================
    const BEAKER_HEIGHT_PX = 400; 
    const BEAKER_MAX_VOLUME_ML = 400; 
    
    // Estado atual da simulação
    let currentSolution = {
        solvent: {
            symbol: '',
            volume: 0, // mL
        },
        solutes: [] // { symbol, name, mass, color, solubilityLimit, dissolvedMass, undissolvedMass }
    };
    
    // Elementos do DOM
    const beakerContainer = document.getElementById('beaker-container'); 
    const dropTarget = document.getElementById('drop-target');
    const beakerSolution = document.getElementById('beaker-solution');
    const beakerSediment = document.getElementById('beaker-sediment');
    const beakerOilLayer = document.getElementById('beaker-oil-layer'); 
    const fallingSubstance = document.getElementById('falling-substance'); 
    
    const volumeInfo = document.getElementById('volume-info');
    const massInfo = document.getElementById('mass-info');
    const concentrationInfo = document.getElementById('concentration-info');
    const classificationInfo = document.getElementById('classification-info');
    const sedimentInfo = document.getElementById('sediment-info');
    const resetButton = document.getElementById('reset-solution');
    const simulationArea = document.getElementById('simulation-area');

    // ==================================================================================================
    // 3. FUNÇÕES DE LÓGICA E CÁLCULO
    // ==================================================================================================

    /**
     * Atualiza a altura, cor e camadas visuais do copo.
     */
    function updateBeakerVisuals() {
        const totalVolume = currentSolution.solvent.volume;
        
        // 1. Altura da Solução Base (Água)
        const solutionHeightPx = Math.min(BEAKER_HEIGHT_PX, (totalVolume / BEAKER_MAX_VOLUME_ML) * BEAKER_HEIGHT_PX);

        // 2. Altura do Sedimento (Fundo) - Apenas sólidos insolúveis (não-óleo)
        const totalUndissolvedSediment = currentSolution.solutes.filter(s => s.solubilityLimit === 0 && s.symbol !== 'C18H34O2')
                                                                 .reduce((sum, s) => sum + s.undissolvedMass, 0);
        // Aproximação visual: 1g de sedimento = 2px de altura
        const sedimentHeightPx = Math.min(solutionHeightPx - 5, totalUndissolvedSediment / 2); 
        beakerSediment.style.height = `${sedimentHeightPx}px`;
        beakerSediment.style.bottom = `0px`; 

        // 3. Posição e Altura da Solução (Acima do Sedimento)
        beakerSolution.style.height = `${solutionHeightPx}px`;
        beakerSolution.style.bottom = `${sedimentHeightPx}px`; 

        // 4. Camada de Óleo (Topo) - Ácido Oleico
        const oleicAcidSolute = currentSolution.solutes.find(s => s.symbol === 'C18H34O2');
        const oleicMass = oleicAcidSolute ? oleicAcidSolute.undissolvedMass : 0; // O óleo nunca dissolve, então a massa não dissolvida é o total.
        
        // Aproximação: 1g de óleo = 2px de altura 
        const oilHeightPx = oleicMass * 2; 
        
        beakerOilLayer.style.height = `${oilHeightPx}px`;
        // O óleo flutua no topo da solução de água
        beakerOilLayer.style.bottom = `${solutionHeightPx + sedimentHeightPx}px`; 
        
        // 5. Cor da Solução
        let baseOpacity = 0.3;
        
        const kmno4Solute = currentSolution.solutes.find(s => s.symbol === 'KMnO4');

        if (kmno4Solute && kmno4Solute.dissolvedMass > 0) {
            // Lógica de Cor para KMnO4 (Roxo/Magenta)
            const concentration = kmno4Solute.dissolvedMass / totalVolume;
            const maxConcentrationVisually = 0.05; 
            
            const intensity = Math.min(1, concentration / maxConcentrationVisually); 
            
            // Cor Roxo (R: 150, G: 0, B: 200). A cor fica mais escura/intensa com a concentração.
            const colorR = Math.round(150 * intensity);
            const colorG = Math.round(0 * intensity);
            const colorB = Math.round(200 * intensity);
            baseOpacity = 0.4 + (0.4 * intensity);
            
            beakerSolution.style.background = `rgba(${colorR}, ${colorG}, ${colorB}, ${baseOpacity.toFixed(2)})`;
        } else {
            // Cor padrão da água
            beakerSolution.style.background = `rgba(100, 149, 237, 0.5)`;
        }

        // 6. Cor e Visibilidade do Sedimento
        if (totalUndissolvedSediment > 0) {
            beakerSediment.style.backgroundColor = '#8B4513'; // Marrom para sedimento
        } else {
            beakerSediment.style.backgroundColor = 'transparent'; 
        }

        // 7. Ajustar o z-index para que o óleo (z=3) flutue sobre a solução (z=2)
        beakerSolution.style.zIndex = 2;
        beakerOilLayer.style.zIndex = 3;
    }

    /**
     * Anima a substância caindo no copo.
     * @param {string} color A cor da animação.
     */
    function animateDrop(color) {
        fallingSubstance.style.animation = 'none';
        fallingSubstance.offsetHeight; 
        
        if (color === 'purple') {
            fallingSubstance.style.backgroundColor = 'rgb(150, 0, 200)';
        } else if (color === 'gray') {
            fallingSubstance.style.backgroundColor = 'rgb(150, 150, 150)';
        } else if (color === 'yellow') {
            fallingSubstance.style.backgroundColor = 'rgb(255, 255, 0)';
        } else {
            fallingSubstance.style.backgroundColor = 'transparent';
        }
        
        fallingSubstance.style.animation = 'fall-in 1.5s ease-in-out forwards';
    }


    /**
     * Recalcula a massa dissolvida, a classificação e atualiza os painéis de resultados.
     */
    function updateSolutionState() {
        const totalVolume = currentSolution.solvent.volume;
        let totalMassDissolved = 0;
        let totalMassUndissolved = 0;
        let totalMassSolute = 0;
        
        // CORREÇÃO CRÍTICA: Resetar o estado de dissolução antes de recalcular
        currentSolution.solutes.forEach(solute => {
            solute.dissolvedMass = 0;
            solute.undissolvedMass = 0;
        });

        // Variável de controle para rastrear a capacidade de saturação utilizada
        let capacityUsed = 0; 
        
        currentSolution.solutes.forEach(solute => {
            const totalMass = solute.mass;
            const solubilityLimit = solute.solubilityLimit; // g/100mL
            
            totalMassSolute += totalMass;
            
            if (totalVolume > 0 && solubilityLimit > 0) {
                // Solúvel
                const currentSolubilityLimit = solubilityLimit * (totalVolume / 100); 

                // Capacidade restante para este e futuros solutos solúveis
                const remainingCapacity = currentSolubilityLimit - capacityUsed;
                
                // Massa que REALMENTE pode ser dissolvida (mínimo entre o total disponível e o restante da capacidade)
                const actualDissolvedMass = Math.max(0, Math.min(totalMass, remainingCapacity));
                
                solute.dissolvedMass = actualDissolvedMass;
                solute.undissolvedMass = totalMass - actualDissolvedMass;
                
                // Atualiza a capacidade utilizada
                capacityUsed += actualDissolvedMass;
            } else if (totalVolume > 0 && solubilityLimit === 0) {
                // Insolúvel (Areia, Óleo)
                solute.dissolvedMass = 0;
                solute.undissolvedMass = totalMass;
            } else {
                // Sem solvente, nada dissolve
                solute.dissolvedMass = 0;
                solute.undissolvedMass = totalMass;
            }

            totalMassDissolved += solute.dissolvedMass;
            totalMassUndissolved += solute.undissolvedMass;
        });

        // 2. Classificação
        let classification;
        let solubleSolutes = currentSolution.solutes.filter(s => s.solubilityLimit > 0);
        let isSaturated = false;
        
        if (totalVolume === 0) {
            classification = "Vazio (Adicione Solvente)";
        } else if (totalMassUndissolved > 0) {
            // Mistura Heterogênea (devido a sedimento ou óleo)
            classification = "Mistura Heterogênea";
            
            // Verifica a saturação apenas para a fase líquida
            isSaturated = solubleSolutes.some(solute => {
                const limitVolume = solute.solubilityLimit * (totalVolume / 100);
                // Checa se o soluto atingiu 95% ou mais de sua capacidade (próximo da saturação)
                return solute.dissolvedMass >= limitVolume * 0.95; 
            });

            if (isSaturated) {
                classification += " (Solução Saturada)";
            } else {
                classification += " (Solução Insaturada)";
            }

        } else if (totalMassSolute === 0) {
            classification = "Solvente Puro (Homogênea)";
        } else {
            // Solução Homogênea (tudo dissolvido)
            isSaturated = solubleSolutes.some(solute => {
                const limitVolume = solute.solubilityLimit * (totalVolume / 100);
                return solute.dissolvedMass >= limitVolume * 0.95;
            });

            if (isSaturated) {
                classification = "Saturada (Homogênea)";
            } else {
                classification = "Insaturada (Homogênea)";
            }
        }


        // 3. Atualização do Painel
        const concentration = totalVolume > 0 ? (totalMassDissolved / totalVolume).toFixed(3) : 0.00;

        volumeInfo.textContent = `${totalVolume.toFixed(0)} mL`;
        massInfo.textContent = `${totalMassSolute.toFixed(2)} g (Total) / ${totalMassDissolved.toFixed(2)} g (Dissolvido)`;
        concentrationInfo.textContent = `${concentration} g/mL`;
        classificationInfo.textContent = classification;
        sedimentInfo.textContent = `${totalMassUndissolved.toFixed(2)} g (Não dissolvido/outra fase)`;
        
        updateBeakerVisuals();
    }

    /**
     * Adiciona um item (solvente ou soluto) ao copo.
     * @param {HTMLElement} itemElement O elemento draggable que foi solto.
     */
    function addItemToSolution(itemElement) {
        const type = itemElement.dataset.type;
        const symbol = itemElement.dataset.symbol;
        const name = itemElement.dataset.name;
        const color = itemElement.dataset.color || 'none'; 
        
        if (type === 'solvent' && currentSolution.solvent.volume === 0) {
            const volume = parseFloat(itemElement.dataset.initialVolume) || 100;
            currentSolution.solvent = { symbol: symbol, volume: volume };
            
            // Remove a mensagem de instrução
            const initialH1 = simulationArea.querySelector('h1:not(.section-title)');
            const initialP = simulationArea.querySelector('p:not(#results-panel p)');
            
            if (initialH1) simulationArea.removeChild(initialH1);
            if (initialP) simulationArea.removeChild(initialP);
            
        } else if (type === 'solute' && currentSolution.solvent.volume > 0) {
            const mass = parseFloat(itemElement.dataset.mass) || 1;
            const solubilityLimit = parseFloat(itemElement.dataset.solubilityLimit) || 0; 
            
            let soluteEntry = currentSolution.solutes.find(s => s.symbol === symbol);
            
            if (soluteEntry) {
                soluteEntry.mass += mass;
            } else {
                currentSolution.solutes.push({
                    symbol: symbol,
                    name: name,
                    mass: mass,
                    color: color,
                    solubilityLimit: solubilityLimit,
                    dissolvedMass: 0,
                    undissolvedMass: 0
                });
            }
            // Chama a animação de queda para o soluto
            animateDrop(color);

        } else if (type === 'solute' && currentSolution.solvent.volume === 0) {
            alert("Por favor, adicione o Solvente (Água) primeiro!");
            return;
        }

        // Delay para permitir que a animação de queda seja visualizada
        setTimeout(updateSolutionState, 500); 
    }

    /**
     * Reinicia o estado da simulação.
     */
    function resetSolution() {
        currentSolution = {
            solvent: { symbol: '', volume: 0 },
            solutes: []
        };
        
        // Garante que o H1 e P de instrução estejam presentes.
        if (!simulationArea.querySelector('h1:not(.section-title)')) {
            const h1 = document.createElement('h1');
            h1.textContent = 'Simulador de Soluções';
            simulationArea.insertBefore(h1, beakerContainer);
        }
        
        if (!simulationArea.querySelector('p:not(#results-panel p)')) {
            const p = document.createElement('p');
            p.textContent = 'Arraste uma substância da esquerda para o copo.';
            simulationArea.insertBefore(p, beakerContainer);
        }

        // Zera os visuais
        beakerSolution.style.height = '0px';
        beakerSediment.style.height = '0px';
        beakerSolution.style.bottom = '0px';
        beakerSolution.style.background = 'rgba(100, 149, 237, 0.5)';
        beakerOilLayer.style.height = '0px'; 
        
        // Zera o painel de resultados
        volumeInfo.textContent = '0 mL';
        massInfo.textContent = '0 g (Total) / 0.00 g (Dissolvido)';
        concentrationInfo.textContent = '0.00 g/mL';
        classificationInfo.textContent = 'Vazio';
        sedimentInfo.textContent = '0 g (Não dissolvido/outra fase)';
    }


    // ==================================================================================================
    // 4. LISTENERS DE ARRASTAR E SOLTAR (DRAG AND DROP)
    // ==================================================================================================

    // 1. Início do Arrastar
    document.querySelectorAll('.draggable-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.id);
        });
    });

    // 2. Sobre o Alvo
    dropTarget.addEventListener('dragover', (e) => {
        e.preventDefault(); 
        dropTarget.style.outline = '2px dashed var(--cor-destaque)';
    });

    // 3. Ao Sair do Alvo
    dropTarget.addEventListener('dragleave', (e) => {
        dropTarget.style.outline = 'none';
    });

    // 4. Soltar no Alvo
    dropTarget.addEventListener('drop', (e) => {
        e.preventDefault();
        dropTarget.style.outline = 'none';
        
        const itemId = e.dataTransfer.getData('text/plain');
        const itemElement = document.getElementById(itemId);
        
        if (itemElement) {
            addItemToSolution(itemElement);
        }
    });
    
    // 5. Listener do Botão Reiniciar
    resetButton.addEventListener('click', resetSolution);

    // 6. Inicialização
    document.addEventListener('DOMContentLoaded', resetSolution); 

</script>

</body>
</html>
