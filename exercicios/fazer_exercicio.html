<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimuLab - Fazer Exercício</title>
    <link rel="icon" type="image/png" href="dados/logo-icon.png"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f8f8;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .top-bar {
            background-color: #D2691E;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: white;
            width: 100%;
            padding: 15px 40px;
            text-align: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: 30px 20px;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #D2691E;
            border-bottom: 2px solid #D2691E;
            padding-bottom: 10px;
            margin-top: 0;
            text-align: center;
        }
        h2.question-title {
            color: #007bff;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        .question-meta {
            margin: 5px 0 15px 0;
            font-size: 0.9em;
            color: #777;
        }
        .question-body {
            background-color: #f4f4f4;
            padding: 15px;
            border-left: 5px solid #D2691E;
            margin: 15px 0;
            border-radius: 4px;
        }
        .options-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        .options-list li {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: flex-start;
        }
        .options-list li:hover {
            background-color: #f0f0f0;
        }
        input[type="radio"], input[type="checkbox"] {
            margin-right: 10px;
            min-width: 18px;
            height: 18px;
            cursor: pointer;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            resize: vertical;
        }
        .error-message {
            text-align: center;
            color: #F44336;
            font-size: 1.2em;
            margin-top: 50px;
        }
        #submitBtn {
            width: 100%;
            padding: 15px;
            background-color: #D2691E;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 40px;
            transition: background-color 0.3s;
        }
        #submitBtn:hover {
            background-color: #c05c18;
        }
        #results {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #007bff;
            background-color: #e6f0ff;
            display: none;
            text-align: center;
        }
        .result-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            text-align: left;
        }
        .correct-answer {
            background-color: #e6ffed;
            border: 1px solid #4CAF50;
        }
        .incorrect-answer {
            background-color: #ffe6e6;
            border: 1px solid #F44336;
        }
        .manual-check {
             background-color: #fff3cd;
             border: 1px solid #ffc107;
        }
    </style>
</head>
<body>
    <header class="top-bar">
        <h2>SimuLab - Plataforma do Aluno</h2>
    </header>

    <div id="exerciseContainer" class="container" style="display: none;">
        <h1 id="mainTitle">Exercício</h1>
        <p style="text-align: center; color: #555;">Responda às questões abaixo.</p>
        
        <form id="answerForm">
            <div id="questionsArea"></div>
            
            <button type="submit" id="submitBtn"><i class="fas fa-check-circle"></i> Finalizar e Ver Pontuação</button>
        </form>
        
        <div id="results">
            <h3><i class="fas fa-poll"></i> Resultado do Exercício</h3>
            <p id="scoreSummary"></p>
            <div id="detailedResults"></div>
        </div>

    </div>

    <div id="errorMessage" class="error-message" style="display: block;">
        Carregando exercício...
    </div>

    <script>
        // =======================================================
        // 1. FUNÇÃO DE DESCOMPRESSÃO (REVERSA DO QR CODE)
        // =======================================================

        /**
         * Reverte a compressão de uma string, restaurando o JSON original.
         * Desfaz a codificação de bytes (UTF-16) + Base64, e o encodeURIComponent.
         */
        function decompressString(compressed) {
            let decompressed = '';
            // 1. Desfaz o Base64
            const binaryString = atob(compressed);
            
            // 2. Desfaz a codificação de bytes (UTF-16)
            for (let i = 0; i < binaryString.length; i++) {
                decompressed += String.fromCharCode(binaryString.charCodeAt(i) - 0x8000);
            }
            
            // 3. Desfaz o encodeURIComponent para restaurar acentos (UTF-8)
            return decodeURIComponent(decompressed);
        }

        // Variável global para armazenar os dados do exercício.
        let questionArray = []; 
        let totalCheckableQuestions = 0;

        // =======================================================
        // 2. FUNÇÃO DE MAXIMIZAÇÃO (REVERSA DA MINIMIZAÇÃO)
        // =======================================================
        /**
         * Restaura os nomes completos das chaves do objeto para o uso na renderização.
         */
        function maximizeQuestions(minimizedQuestions) {
            return minimizedQuestions.map(mq => {
                const full = {
                    id: mq.id,
                    title: mq.t,
                    materia: mq.m,
                    dificuldade: mq.d,
                    questionText: mq.tx,
                };
                
                // Restaura o nome completo do tipo com base na primeira letra
                if (mq.ty === 'M') {
                    full.tipo = 'Múltipla Escolha';
                    full.options = mq.opts.map(opt => ({
                        text: opt.txt,
                        isCorrect: opt.c
                    }));
                } else if (mq.ty === 'V') {
                    full.tipo = 'Verdadeiro ou Falso';
                    full.correctAnswer = mq.a;
                } else if (mq.ty === 'D') {
                    full.tipo = 'Discursiva';
                    full.answerHint = mq.h;
                }
                return full;
            });
        }

        /**
         * Renderiza o exercício com base nos dados decodificados (agora um array).
         */
        function renderExercise(questions) {
            questionArray = questions;
            totalCheckableQuestions = 0;

            if (questions.length === 0) {
                 document.getElementById('errorMessage').innerHTML = `<i class="fas fa-exclamation-triangle"></i> Erro: Exercício Vazio.`;
                 return;
            }

            document.getElementById('mainTitle').textContent = `Exercício: ${questions[0].materia} (${questions.length} Questões)`;
            
            const questionsArea = document.getElementById('questionsArea');
            questionsArea.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionNumber = index + 1;
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question');
                questionDiv.setAttribute('data-id', q.id);

                let answerInputHtml = '';
                
                if (q.tipo === 'Múltipla Escolha' && q.options) {
                    totalCheckableQuestions++;
                    answerInputHtml = '<ul class="options-list">';
                    q.options.forEach((option, optIndex) => {
                        answerInputHtml += `
                            <li>
                                <input type="radio" name="q_${q.id}" id="q_${q.id}_opt${optIndex}" value="${optIndex}" required>
                                <label for="q_${q.id}_opt${optIndex}">${option.text}</label>
                            </li>
                        `;
                    });
                    answerInputHtml += '</ul>';
                
                } else if (q.tipo === 'Verdadeiro ou Falso') {
                    totalCheckableQuestions++;
                    answerInputHtml = `
                        <ul class="options-list">
                            <li>
                                <input type="radio" name="q_${q.id}" id="q_${q.id}_true" value="true" required>
                                <label for="q_${q.id}_true">Verdadeiro</label>
                            </li>
                            <li>
                                <input type="radio" name="q_${q.id}" id="q_${q.id}_false" value="false" required>
                                <label for="q_${q.id}_false">Falso</label>
                            </li>
                        </ul>
                    `;
                } else if (q.tipo === 'Discursiva') {
                    answerInputHtml = `
                        <p style="color: #F44336; font-weight: bold;">(Correção Manual)</p>
                        <textarea name="q_${q.id}" rows="5" placeholder="Digite sua resposta aqui..." required></textarea>
                    `;
                }

                questionDiv.innerHTML = `
                    <h2 class="question-title">Questão ${questionNumber}: ${q.title}</h2>
                    <div class="question-meta">
                        Tipo: ${q.tipo} | Dificuldade: ${q.dificuldade}
                    </div>
                    <div class="question-body">${q.questionText}</div>
                    <div class="answer-area">${answerInputHtml}</div>
                `;
                questionsArea.appendChild(questionDiv);
            });
            
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('exerciseContainer').style.display = 'block';
        }


        /**
         * Verifica a resposta do aluno para todas as questões.
         */
        function checkAllAnswers(event) {
            event.preventDefault();
            const form = event.target;
            const detailedResults = document.getElementById('detailedResults');
            const resultsDiv = document.getElementById('results');
            let correctAnswers = 0;
            let totalQuestionsChecked = 0;
            
            detailedResults.innerHTML = '';
            
            questionArray.forEach((q, index) => {
                const questionNumber = index + 1;
                let resultClass = '';
                let resultText = '';
                const studentAnswerInput = form.querySelector(`[name="q_${q.id}"]:checked, [name="q_${q.id}"]`);
                
                if (!studentAnswerInput && q.tipo !== 'Discursiva') {
                    return; 
                }

                if (q.tipo === 'Múltipla Escolha') {
                    totalQuestionsChecked++;
                    const selectedIndex = parseInt(studentAnswerInput.value);
                    const isCorrect = q.options.find((opt, i) => i === selectedIndex)?.isCorrect;

                    if (isCorrect) {
                        correctAnswers++;
                        resultClass = 'correct-answer';
                        resultText = 'Correta!';
                    } else {
                        const correctAnswerText = q.options.find(opt => opt.isCorrect)?.text || 'N/A';
                        resultClass = 'incorrect-answer';
                        resultText = `Incorreta. Resposta correta: ${correctAnswerText}`;
                    }

                } else if (q.tipo === 'Verdadeiro ou Falso') {
                    totalQuestionsChecked++;
                    const selectedAnswer = studentAnswerInput.value === 'true';
                    const isCorrect = selectedAnswer === q.correctAnswer;
                    
                    if (isCorrect) {
                        correctAnswers++;
                        resultClass = 'correct-answer';
                        resultText = 'Correta!';
                    } else {
                        const correctAnswerText = q.correctAnswer ? 'Verdadeiro' : 'Falso';
                        resultClass = 'incorrect-answer';
                        resultText = `Incorreta. Resposta correta: ${correctAnswerText}`;
                    }

                } else if (q.tipo === 'Discursiva') {
                    resultClass = 'manual-check';
                    resultText = 'Requer correção manual do professor.';
                    
                    if (q.answerHint) {
                         resultText += ` (Gabarito/Critérios: ${q.answerHint})`;
                    }
                }

                detailedResults.innerHTML += `
                    <div class="result-item ${resultClass}">
                        <i class="fas fa-check" style="color: ${resultClass === 'correct-answer' ? '#4CAF50' : (resultClass === 'incorrect-answer' ? '#F44336' : '#ffc107')}; margin-right: 8px;"></i>
                        <strong>Q${questionNumber} (${q.tipo}):</strong> ${resultText}
                    </div>
                `;
            });

            // Sumário da Pontuação
            const scorePercent = totalQuestionsChecked > 0 ? ((correctAnswers / totalQuestionsChecked) * 100).toFixed(0) : 0;
            document.getElementById('scoreSummary').innerHTML = 
                `Você acertou <strong>${correctAnswers}</strong> de <strong>${totalQuestionsChecked}</strong> questões de correção automática. (${scorePercent}%)`;

            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            document.getElementById('submitBtn').disabled = true; 
        }


        // =======================================================
        // 3. LÓGICA DE INICIALIZAÇÃO
        // =======================================================
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.substring(1); 
            
            if (!hash) {
                document.getElementById('errorMessage').innerHTML = `<i class="fas fa-exclamation-triangle"></i> Erro: Nenhum exercício encontrado no link.`;
                return;
            }

            try {
                // 1. DESCOMPRIME a Base64 e o JSON
                const jsonString = decompressString(hash);
                // O JSON descompactado é o array minimizado
                const minimizedQuestions = JSON.parse(jsonString); 
                
                if (!Array.isArray(minimizedQuestions) || minimizedQuestions.length === 0) {
                     throw new Error("Dados de exercício inválidos ou vazios.");
                }

                // 2. Maximiza o array para a renderização
                const questions = maximizeQuestions(minimizedQuestions);

                // 3. Renderiza o exercício completo
                renderExercise(questions);

                // 4. Adiciona o listener para o formulário de resposta
                document.getElementById('answerForm').addEventListener('submit', checkAllAnswers);
                
            } catch (e) {
                console.error("Erro ao carregar ou decodificar o exercício:", e);
                 document.getElementById('errorMessage').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> Erro: Não foi possível decodificar o exercício. O link pode estar corrompido ou ser grande demais.
                    <p style="font-size: 0.8em; margin-top: 10px;">Detalhes: ${e.message}</p>
                `;
            }
        });
    </script>
</body>
</html>
